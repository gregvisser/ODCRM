generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Schema version: 2026-01-17 - Fixed relation names and model mappings

// ============================================================================
// ENUMS
// ============================================================================

enum ContactStatus {
  active
  inactive
  unsubscribed
  bounced
}

enum ClientStatus {
  active
  inactive
  onboarding
  win_back
}

enum CampaignStatus {
  draft
  running
  paused
  completed
}

enum EventType {
  sent
  delivered
  opened
  clicked
  replied
  bounced
  opted_out
  spam_complaint
  failed
  not_reached
}

enum MessageDirection {
  outbound
  inbound
}

enum LeadStatus {
  new
  qualified
  nurturing
  closed
  converted
}

enum ProspectStatus {
  pending
  sending      // Atomic lock status - claim before sending
  step1_sent
  step2_sent
  step3_sent
  step4_sent
  step5_sent
  step6_sent
  step7_sent
  step8_sent
  step9_sent
  step10_sent
  bounced
  unsubscribed
  replied
  suppressed
  completed
}

// ============================================================================
// MODELS (PascalCase with @@map to snake_case tables)
// ============================================================================

model Customer {
  id                    String               @id @default(cuid())
  name                  String
  domain                String?
  accountData           Json?
  
  // Business details (from OpensDoorsV2 ClientAccount)
  leadsReportingUrl     String?
  leadsGoogleSheetLabel String?              // Custom display name for leads Google Sheet
  sector                String?
  clientStatus          ClientStatus         @default(active)
  targetJobTitle        String?
  prospectingLocation   String?
  
  // About section (AI-enriched company data)
  website               String?
  whatTheyDo            String?              @db.Text
  accreditations        String?
  keyLeaders            String?
  companyProfile        String?              @db.Text
  recentNews            String?              @db.Text
  companySize           String?
  headquarters          String?
  foundingYear          String?
  socialPresence        Json?                // Array of { label: string, url: string }
  lastEnrichedAt        DateTime?
  
  // Financial & performance tracking
  monthlyIntakeGBP            Decimal?       @db.Decimal(10, 2)  // Customer's monthly intake
  monthlyRevenueFromCustomer  Decimal?       @db.Decimal(10, 2)  // ODCRM revenue from this customer
  defcon                      Int?           // Priority level 1-6
  
  // Lead targets & actuals
  weeklyLeadTarget      Int?
  weeklyLeadActual      Int?
  monthlyLeadTarget     Int?
  monthlyLeadActual     Int?
  
  // Agreement upload (Phase 2 Item 4)
  agreementFileUrl      String?              // LEGACY: Direct blob URL (deprecated, use SAS instead)
  agreementFileName     String?
  agreementFileMimeType String?
  agreementUploadedAt   DateTime?
  agreementUploadedByEmail String?          // Server-derived only from auth context
  agreementBlobName     String?              // Blob name in Azure Storage (for SAS generation)
  agreementContainerName String?             // Container name (default: customer-agreements)
  
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  
  // Relations
  contacts              Contact[]
  emailCampaigns        EmailCampaign[]
  emailIdentities       EmailIdentity[]
  customerContacts      CustomerContact[]
  contactLists          ContactList[]
  emailSequences        EmailSequence[]
  emailTemplates        EmailTemplate[]
  emailEvents           EmailEvent[]
  leadRecords           LeadRecord[]
  leadSyncState         LeadSyncState?
  suppressionEntries    SuppressionEntry[]
  sheetSourceConfigs    SheetSourceConfig[]
  contactSourceRows     ContactSourceRow[]

  @@index([id])
  @@index([domain])
  @@index([name])
  @@index([clientStatus])
  @@map("customers")
}

model Contact {
  id                       String                     @id @default(cuid())
  customerId               String
  firstName                String
  lastName                 String
  jobTitle                 String?
  companyName              String
  email                    String
  phone                    String?
  source                   String                     @default("cognism")
  status                   ContactStatus              @default(active)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  
  // Relations
  customer                 Customer                   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  emailCampaignProspects   EmailCampaignProspect[]
  contactListMembers       ContactListMember[]
  convertedFromLead        LeadRecord[]               @relation("LeadToContact")
  sequenceEnrollments      SequenceEnrollment[]
  sourceRows               ContactSourceRow[]

  @@index([customerId, email])
  @@index([customerId])
  @@index([email])
  @@index([status])
  @@map("contacts")
}

model EmailIdentity {
  id                       String                     @id @default(cuid())
  customerId               String
  emailAddress             String
  displayName              String?
  provider                 String                     @default("outlook") // "outlook" or "smtp"
  
  // OAuth fields (for Outlook)
  outlookTenantId          String?
  outlookUserId            String?
  accessToken              String?
  refreshToken             String?
  tokenExpiresAt           DateTime?
  
  // SMTP fields (for manual email accounts)
  smtpHost                 String?
  smtpPort                 Int?
  smtpUsername             String?
  smtpPassword             String?
  smtpSecure               Boolean?                   @default(true)
  
  dailySendLimit           Int                        @default(150)
  sendWindowHoursStart     Int                        @default(9)  // 9 AM
  sendWindowHoursEnd       Int                        @default(17) // 5 PM
  sendWindowTimeZone       String                     @default("UTC")
  isActive                 Boolean                    @default(true)
  lastCheckedAt            DateTime?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  
  // Relations
  customer                 Customer                   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  emailCampaignProspects   EmailCampaignProspect[]
  emailCampaigns           EmailCampaign[]
  emailMessageMetadata     EmailMessageMetadata[]
  sentEmailEvents          EmailEvent[]               @relation("EmailIdentitySentEvents")
  sentSequences            EmailSequence[]

  @@unique([customerId, emailAddress])
  @@index([customerId])
  @@index([emailAddress])
  @@index([isActive])
  @@index([provider])
  @@map("email_identities")
}

model EmailCampaign {
  id                       String                     @id @default(cuid())
  customerId               String
  name                     String
  description              String?
  status                   CampaignStatus             @default(draft)
  senderIdentityId         String?
  
  // Optional: link to list and sequence (OpensDoorsV2 workflow)
  listId                   String?
  sequenceId               String?
  
  sendWindowHoursStart     Int                        @default(9)
  sendWindowHoursEnd       Int                        @default(17)
  randomizeWithinHours     Int                        @default(24)
  followUpDelayDaysMin     Int                        @default(3)
  followUpDelayDaysMax     Int                        @default(5)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  
  // Relations
  customer                 Customer                   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  senderIdentity           EmailIdentity?             @relation(fields: [senderIdentityId], references: [id])
  list                     ContactList?               @relation("CampaignToList", fields: [listId], references: [id])
  sequence                 EmailSequence?             @relation("CampaignToSequence", fields: [sequenceId], references: [id])
  prospects                EmailCampaignProspect[]
  templates                EmailCampaignTemplate[]
  prospectSteps            EmailCampaignProspectStep[]
  events                   EmailEvent[]

  @@index([customerId])
  @@index([customerId, status])
  @@index([senderIdentityId])
  @@index([status])
  @@index([listId])
  @@index([sequenceId])
  @@map("email_campaigns")
}

model EmailCampaignTemplate {
  id               String          @id @default(cuid())
  campaignId       String
  stepNumber       Int
  /// Delay AFTER the previous step before this step is eligible to send.
  /// Step 1 should generally be 0/0 ("right away").
  ///
  /// If null, the system will fall back to the campaign-level followUpDelayDaysMin/Max.
  delayDaysMin     Int?
  delayDaysMax     Int?
  subjectTemplate  String
  bodyTemplateHtml String
  bodyTemplateText String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  // Relations
  campaign         EmailCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, stepNumber])
  @@index([campaignId])
  @@map("email_campaign_templates")
}

model EmailTemplate {
  id               String   @id @default(cuid())
  customerId       String
  name             String
  subjectTemplate  String
  bodyTemplateHtml String
  bodyTemplateText String?
  stepNumber       Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  customer         Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([stepNumber])
  @@map("email_templates")
}

model EmailCampaignProspect {
  id                     String                   @id @default(cuid())
  campaignId             String
  contactId              String
  senderIdentityId       String
  step1ScheduledAt       DateTime?
  step1SentAt            DateTime?
  step2ScheduledAt       DateTime?
  step2SentAt            DateTime?
  lastStatus             ProspectStatus           @default(pending)
  openCount              Int                      @default(0)
  lastOpenedAt           DateTime?
  unsubscribedAt         DateTime?
  bouncedAt              DateTime?
  replyDetectedAt        DateTime?
  replyCount             Int                      @default(0)
  lastReplySnippet       String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  
  // Relations
  campaign               EmailCampaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact                Contact                  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  senderIdentity         EmailIdentity            @relation(fields: [senderIdentityId], references: [id])
  emailEvents            EmailEvent[]
  emailMessageMetadata   EmailMessageMetadata[]
  emailCampaignProspectSteps EmailCampaignProspectStep[]

  @@index([campaignId])
  @@index([campaignId, lastStatus])
  @@index([contactId])
  @@index([lastStatus])
  @@index([senderIdentityId])
  @@index([step1ScheduledAt])
  @@index([step2ScheduledAt])
  @@map("email_campaign_prospects")
}

model EmailCampaignProspectStep {
  id                 String                 @id @default(cuid())
  campaignId         String
  campaignProspectId String
  stepNumber         Int
  scheduledAt        DateTime?
  claimedAt          DateTime?              // Atomic lock for sending
  claimedBy          String?                // Instance ID that claimed
  sentAt             DateTime?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  
  // Relations
  campaign           EmailCampaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignProspect   EmailCampaignProspect  @relation(fields: [campaignProspectId], references: [id], onDelete: Cascade)

  @@unique([campaignProspectId, stepNumber])
  @@index([campaignId, stepNumber])
  @@index([campaignId, scheduledAt])
  @@index([campaignProspectId])
  @@index([scheduledAt])
  @@map("email_campaign_prospect_steps")
}

model EmailEvent {
  id                       String                   @id @default(cuid())
  customerId               String
  campaignId               String
  campaignProspectId       String?
  senderIdentityId         String?
  recipientEmail           String?
  type                     EventType
  metadata                 Json?
  occurredAt               DateTime                 @default(now())
  createdAt                DateTime                 @default(now())

  // Relations
  customer                 Customer                 @relation(fields: [customerId], references: [id], onDelete: Cascade)
  campaign                 EmailCampaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignProspect         EmailCampaignProspect?   @relation(fields: [campaignProspectId], references: [id], onDelete: Cascade)
  senderIdentity           EmailIdentity?           @relation("EmailIdentitySentEvents", fields: [senderIdentityId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([customerId, occurredAt])
  @@index([customerId, type])
  @@index([customerId, type, occurredAt])
  @@index([campaignId])
  @@index([campaignId, type])
  @@index([campaignProspectId])
  @@index([senderIdentityId])
  @@index([occurredAt])
  @@index([type])
  @@map("email_events")
}

model SuppressionEntry {
  id                String   @id @default(cuid())
  customerId        String
  type              String   // "domain" | "email"
  value             String   // normalized email or domain
  emailNormalized   String?  // normalized email (lowercase, trimmed) for email type entries
  reason            String?
  source            String?  // "manual" | "import" | "bounce" | "unsubscribe"
  sourceFileName    String?  // filename when imported from CSV
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, type, value])
  @@index([customerId])
  @@index([customerId, emailNormalized])
  @@index([type])
  @@index([value])
  @@map("suppression_entries")
}

model EmailMessageMetadata {
  id                       String                    @id @default(cuid())
  campaignProspectId       String?
  senderIdentityId         String
  providerMessageId        String                    @unique
  threadId                 String?
  direction                MessageDirection          @default(outbound)
  fromAddress              String
  toAddress                String
  subject                  String
  rawHeaders               Json?
  createdAt                DateTime                  @default(now())
  
  // Relations
  campaignProspect         EmailCampaignProspect?    @relation(fields: [campaignProspectId], references: [id])
  senderIdentity           EmailIdentity             @relation(fields: [senderIdentityId], references: [id], onDelete: Cascade)

  @@index([campaignProspectId])
  @@index([providerMessageId, threadId])
  @@index([senderIdentityId])
  @@index([threadId])
  @@index([toAddress])
  @@map("email_message_metadata")
}

// Client contacts (people at the customer's company - our POCs)
model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  name       String
  email      String?
  phone      String?
  title      String?
  isPrimary  Boolean  @default(false)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([email])
  @@map("customer_contacts")
}

// Contact Lists (from OpensDoorsV2)
model ContactList {
  id                   String                 @id @default(cuid())
  customerId           String
  name                 String
  description          String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  
  // Relations
  customer             Customer               @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contactListMembers   ContactListMember[]
  sourceRows           ContactSourceRow[]
  emailCampaigns       EmailCampaign[]        @relation("CampaignToList")

  @@index([customerId])
  @@index([customerId, name])
  @@map("contact_lists")
}

model ContactSourceRow {
  id             String       @id @default(cuid())
  customerId     String
  contactId      String
  listId         String
  source         SheetSource
  sheetName      String
  sheetRowNumber Int
  rawData        Json
  createdAt      DateTime     @default(now())

  contact        Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  list           ContactList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([listId])
  @@index([contactId])
  @@map("contact_source_rows")
}

model ContactListMember {
  id        String        @id @default(cuid())
  listId    String
  contactId String
  createdAt DateTime      @default(now())
  
  // Relations
  list      ContactList   @relation(fields: [listId], references: [id], onDelete: Cascade)
  contact   Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([listId, contactId])
  @@index([listId])
  @@index([contactId])
  @@map("contact_list_members")
}

// Email Sequences (reusable multi-step workflows)
model EmailSequence {
  id               String                   @id @default(cuid())
  customerId       String
  senderIdentityId String
  name             String
  description      String?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  // Relations
  customer         Customer                 @relation(fields: [customerId], references: [id], onDelete: Cascade)
  senderIdentity   EmailIdentity            @relation(fields: [senderIdentityId], references: [id], onDelete: Cascade)
  steps            EmailSequenceStep[]
  campaigns        EmailCampaign[]          @relation("CampaignToSequence")
  enrollments      SequenceEnrollment[]

  @@index([customerId])
  @@index([customerId, senderIdentityId])
  @@index([customerId, name])
  @@map("email_sequences")
}

model EmailSequenceStep {
  id                    String          @id @default(cuid())
  sequenceId            String
  stepOrder             Int
  delayDaysFromPrevious Int             @default(0)
  subjectTemplate       String
  bodyTemplateHtml      String
  bodyTemplateText      String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  sequence              EmailSequence   @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
  @@map("email_sequence_steps")
}

// Sequence enrollments (contacts enrolled in sequences)
model SequenceEnrollment {
  id                     String          @id @default(cuid())
  sequenceId             String
  contactId               String
  enrolledAt             DateTime        @default(now())
  enrolledBy             String?
  status                 String          @default("active") // 'active', 'paused', 'completed', 'stopped', 'bounced', 'unsubscribed'
  lastStepCompletedAt    DateTime?
  nextStepScheduledAt    DateTime?
  completedAt            DateTime?
  totalEmailsSent        Int             @default(0)
  totalOpens             Int             @default(0)
  totalClicks            Int             @default(0)
  totalReplies           Int             @default(0)

  // Relations
  sequence               EmailSequence   @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  contact                Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, contactId])
  @@index([sequenceId])
  @@index([contactId])
  @@index([status])
  @@index([nextStepScheduledAt])
  @@map("sequence_enrollments")
}

// Marketing leads imported from customer Google Sheets
model LeadRecord {
  id         String   @id @default(cuid())
  customerId String
  accountName String
  data       Json
  sourceUrl  String?
  sheetGid   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Lead status and conversion tracking
  status     LeadStatus @default(new)
  score      Int?       // Lead score based on channel/outcome (0-100)
  convertedToContactId String? // ID of contact if converted
  convertedAt DateTime?
  qualifiedAt DateTime?
  enrolledInSequenceId String? // ID of sequence if auto-enrolled
  
  // Relations
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  convertedContact Contact? @relation("LeadToContact", fields: [convertedToContactId], references: [id])

  @@index([customerId])
  @@index([accountName])
  @@index([updatedAt])
  @@index([status])
  @@index([score])
  @@index([convertedToContactId])
  @@map("lead_records")
}

model LeadSyncState {
  id            String   @id @default(cuid())
  customerId    String   @unique
  lastSyncAt    DateTime?
  lastSuccessAt DateTime?
  lastError     String?
  rowCount      Int?
  lastChecksum  String?  // MD5 checksum for change detection
  
  // Sync status and control
  isPaused      Boolean  @default(false)
  isRunning     Boolean  @default(false)
  
  // Performance metrics
  syncDuration  Int?     // Duration in milliseconds
  rowsProcessed Int?     // Number of rows processed in last sync
  rowsInserted  Int?     // Number of rows inserted
  rowsUpdated   Int?     // Number of rows updated
  rowsDeleted   Int?     // Number of rows deleted
  errorCount    Int      @default(0)
  retryCount    Int      @default(0)
  
  // Progress tracking
  progressPercent Int?   // 0-100
  progressMessage String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([lastSyncAt])
  @@index([isPaused])
  @@index([isRunning])
  @@map("lead_sync_states")
}

model JobSector {
  id        String   @id @default(cuid())
  label     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([label])
  @@map("job_sectors")
}

model JobRole {
  id        String   @id @default(cuid())
  label     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([label])
  @@map("job_roles")
}

// User authorization model (migrated from localStorage)
model User {
  id              String   @id @default(cuid())
  userId          String   @unique  // ODS + 8 numbers format
  firstName       String
  lastName        String
  email           String   @unique
  username        String
  phoneNumber     String?
  role            String
  department      String
  accountStatus   String   @default("Active")  // "Active" or "Inactive"
  lastLoginDate   DateTime?
  profilePhoto    String?  @db.Text  // Base64 data URL
  createdDate     DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  preferences     UserPreferences?

  @@index([email])
  @@index([userId])
  @@index([accountStatus])
  @@map("users")
}

// User preferences (UI settings, tab orders, etc.)
model UserPreferences {
  id              String   @id @default(cuid())
  userEmail       String   @unique  // User's email (primary identifier)
  preferences     Json     // Flexible JSON structure for all preferences
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User?    @relation(fields: [userEmail], references: [email], onDelete: Cascade)

  @@index([userEmail])
  @@map("user_preferences")
}

// ============================================================================
// AUDIT TRAIL
// ============================================================================

// Customer audit events for tracking workflow transitions and critical actions
model CustomerAuditEvent {
  id              String       @id @default(cuid())
  customerId      String
  action          String       // "complete_onboarding", "status_change", etc.
  actorUserId     String?      // User ID who performed the action
  actorEmail      String?      // Email of actor (fallback if userId not available)
  fromStatus      ClientStatus?
  toStatus        ClientStatus?
  metadata        Json?        // Additional context (reason, notes, etc.)
  createdAt       DateTime     @default(now())

  @@index([customerId])
  @@index([customerId, action])
  @@index([customerId, createdAt])
  @@index([action])
  @@map("customer_audit_events")
}

// ============================================================================
// LEAD SOURCES (Google Sheets Integration)
// ============================================================================

enum SheetSource {
  cognism
  apollo
  blackbook
}

enum SheetSyncStatus {
  pending
  syncing
  success
  error
}

// Configuration for each lead source sheet per customer
model SheetSourceConfig {
  id              String          @id @default(cuid())
  customerId      String
  source          SheetSource     // cognism, apollo, blackbook
  sheetUrl        String?         // Full Google Sheets URL
  sheetId         String?         // Extracted spreadsheet ID
  gid             String?         // Sheet tab GID (optional)
  sheetName       String?         // Sheet tab name (optional)
  mappings        Json?           // Field mappings detected from sheet headers
  lastSyncAt      DateTime?
  lastSyncStatus  SheetSyncStatus @default(pending)
  lastError       String?
  rowsImported    Int             @default(0)
  rowsUpdated     Int             @default(0)
  rowsSkipped     Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, source])
  @@index([customerId])
  @@index([source])
  @@map("sheet_source_configs")
}
