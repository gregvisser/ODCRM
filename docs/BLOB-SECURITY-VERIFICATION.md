# Blob Security Verification Guide

## Overview

This guide verifies that the Azure Blob Storage container is properly secured with **private access + SAS-only** architecture.

**Security Requirement:** Customer agreements must NOT be accessible via direct blob URLs. All access must go through time-limited SAS tokens generated by the backend.

---

## Step 1: Set Container to Private (Azure Portal)

### Via Azure Portal (Recommended)

1. **Navigate to Storage Account**
   - Go to: Azure Portal → **Storage Accounts**
   - Select: Your storage account (e.g., `odcrmstorage`)

2. **Open Containers**
   - Left sidebar → **Data storage** → **Containers**

3. **Locate Agreement Container**
   - Find: `customer-agreements` (or value from `AZURE_STORAGE_CONTAINER_AGREEMENTS`)
   - Current access level will be shown (likely "Blob" = public)

4. **Change Access Level**
   - Click the container name: **`customer-agreements`**
   - Top menu → **Change access level**
   - Select: **Private (no anonymous access)** ✅
   - Click **OK**

5. **Verify Change**
   - Container list should now show: **Access level: Private**
   - ✅ Success: No anonymous access allowed

### Via Azure CLI (Alternative)

```bash
# Login to Azure
az login

# Set container to private
az storage container set-permission \
  --name customer-agreements \
  --public-access off \
  --account-name <your-storage-account-name> \
  --auth-mode login

# Verify
az storage container show \
  --name customer-agreements \
  --account-name <your-storage-account-name> \
  --query "properties.publicAccess" \
  --auth-mode login

# Expected output: null (means private)
```

---

## Step 2: Test Security (Automated)

### Test A: Direct Blob URL Must Fail

**Objective:** Verify that direct blob URLs return 404/401 errors after container is private.

```bash
# Get a blob URL from the database or upload response
# Example: https://odcrmstorage.blob.core.windows.net/customer-agreements/agreement_cust_123_1234567890_contract.pdf

BLOB_URL="https://<storage-account>.blob.core.windows.net/customer-agreements/<blob-name>.pdf"

# Try to access without SAS token
curl -I "$BLOB_URL"

# ✅ Expected Result (SUCCESS - security working):
# HTTP/1.1 404 ResourceNotFound
# OR
# HTTP/1.1 401 Unauthorized
#
# Error body (XML):
# <Error>
#   <Code>AuthenticationFailed</Code>
#   <Message>Server failed to authenticate the request. Make sure the value of Authorization header is formed correctly including the signature.</Message>
# </Error>

# ❌ Failure (SECURITY BREACH):
# HTTP/1.1 200 OK
# Content-Type: application/pdf
# [PDF file downloads]
# → Container is still public! Re-check Azure Portal settings.
```

### Test B: SAS URL Must Work

**Objective:** Verify backend can generate valid SAS URLs that grant temporary access.

```bash
# Call backend SAS endpoint (replace with actual customer ID)
CUSTOMER_ID="cust_abc123"
API_URL="http://localhost:3001" # or https://odcrm-api-hkbsfbdzdvezedg8.westeurope-01.azurewebsites.net

curl -X GET "$API_URL/api/customers/$CUSTOMER_ID/agreement-download" | jq

# ✅ Expected Response:
{
  "url": "https://odcrmstorage.blob.core.windows.net/customer-agreements/agreement_...pdf?sv=2023-11-03&st=...&se=...&sr=b&sp=r&sig=...",
  "fileName": "agreement.pdf",
  "mimeType": "application/pdf",
  "expiresAt": "2026-02-10T19:30:00.000Z"
}

# Extract SAS URL
SAS_URL="<url-from-response>"

# Test 1: Immediate access works
curl -I "$SAS_URL"
# ✅ Expected: HTTP/1.1 200 OK
# Content-Type: application/pdf

# Test 2: Can download file
curl -o test-download.pdf "$SAS_URL"
# ✅ Expected: File downloads successfully

# Test 3: SAS expires after 15 minutes
# Wait 16 minutes, then:
curl -I "$SAS_URL"
# ✅ Expected: HTTP/1.1 403 Forbidden
# Error: AuthenticationFailed (signature expired)
```

### Test C: Frontend Integration

**Objective:** Verify frontend correctly uses SAS endpoint, not direct URLs.

```javascript
// Open https://odcrm.bidlow.co.uk
// Press F12 → Console
// Replace <customer-id> with actual customer ID that has an agreement

const customerId = 'cust_abc123'; // Replace with real ID

// Test: Fetch SAS URL
const response = await fetch(`/api/customers/${customerId}/agreement-download`);
const data = await response.json();

console.log('SAS Response:', data);
// ✅ Expected: { url, fileName, mimeType, expiresAt }

// Test: Open in new tab
window.open(data.url, '_blank');
// ✅ Expected: PDF opens in new tab

// Test: SAS URL has query parameters
console.log('Has SAS token:', data.url.includes('?sv='));
// ✅ Expected: true

// Test: URL is NOT a direct blob URL (should have SAS params)
console.log('Is direct URL (BAD):', !data.url.includes('?'));
// ✅ Expected: false
```

---

## Step 3: Verify Code Changes

### Backend Changes

**File:** `server/src/utils/blobUpload.ts`

```typescript
// ✅ CORRECT (after fix):
await containerClient.createIfNotExists({
  access: 'none', // PRIVATE: No public access - SAS URLs required
})

// ❌ INCORRECT (before fix):
await containerClient.createIfNotExists({
  access: 'blob', // Public read access for blobs
})
```

**File:** `server/src/routes/customers.ts`

Upload endpoint stores blob metadata (no direct URLs):

```typescript
// ✅ CORRECT: Only blob reference stored
data: {
  agreementBlobName: blobName,
  agreementContainerName: containerName,
  agreementFileUrl: null, // Not used for access
}
```

Download endpoint generates SAS:

```typescript
// ✅ CORRECT: SAS generation with expiry
const sasResult = await generateAgreementSasUrl({
  containerName: customer.agreementContainerName,
  blobName: customer.agreementBlobName,
  ttlMinutes: 15
})
```

### Frontend Changes

**No changes required** - frontend already uses SAS endpoint:

```typescript
// ✅ CORRECT: Calls SAS endpoint
const response = await fetch(`/api/customers/${customer.id}/agreement-download`)
```

---

## Step 4: Production Verification Checklist

After deploying changes to production:

```
[ ] Code deployed to Azure App Service
[ ] Container set to Private in Azure Portal
[ ] Direct blob URL returns 404/401 (tested)
[ ] SAS endpoint generates valid URLs (tested)
[ ] SAS URLs expire after 15 minutes (tested)
[ ] Frontend "View Agreement" works (tested)
[ ] No console errors (checked F12)
[ ] Existing agreements still accessible (verified)
```

---

## Troubleshooting

### Problem: Direct URLs still work after setting container private

**Solution:**
1. Check Azure Portal container access level (must be "Private")
2. Force refresh browser: `Ctrl+Shift+R`
3. Wait 2-3 minutes for Azure CDN cache to clear
4. Try from incognito/private browsing window

### Problem: SAS URLs return 403 Forbidden

**Possible Causes:**
1. Container access level changed but code not deployed
2. `AZURE_STORAGE_CONNECTION_STRING` missing or incorrect
3. Blob doesn't exist (check database vs. actual blob storage)
4. SAS expired (check `expiresAt` timestamp)

**Solution:**
```bash
# Verify blob exists
az storage blob list \
  --container-name customer-agreements \
  --account-name <storage-account> \
  --query "[].name" \
  --auth-mode login

# Check environment variables on Azure App Service
az webapp config appsettings list \
  --name <app-service-name> \
  --resource-group <resource-group> \
  --query "[?name=='AZURE_STORAGE_CONNECTION_STRING']"
```

### Problem: Old agreements won't open

**Cause:** Old records might have `agreementFileUrl` but no `agreementBlobName`

**Solution:** Backend has backward compatibility logic that parses legacy URLs:

```typescript
// Automatic backfill in customers.ts lines 1258-1272
if (customer.agreementFileUrl) {
  // Parse blob name from legacy URL
  // Backfill agreementBlobName and agreementContainerName
  // Generate SAS as normal
}
```

This should work automatically. If not:
1. Check backend logs for parsing errors
2. Manually update database records with correct blob names

---

## Security Best Practices

### ✅ DO:
- Keep containers private (access: 'none')
- Generate SAS with minimal TTL (15 minutes)
- Log all SAS generation attempts
- Verify blob exists before generating SAS
- Use read-only SAS permissions
- Include clock skew tolerance (±5 minutes)

### ❌ DON'T:
- Store direct blob URLs in database
- Set container to public access
- Generate SAS with long TTLs (>1 hour)
- Skip blob existence checks
- Grant write/delete permissions in SAS
- Expose SAS generation logic to frontend

---

## Monitoring & Alerts

Set up Azure Monitor alerts for:

1. **Failed SAS generations** (backend errors)
2. **Direct blob access attempts** (should be 0 after private)
3. **Storage account authentication failures** (potential attacks)
4. **Unusual SAS generation patterns** (possible abuse)

---

## Compliance Notes

### GDPR
- Customer agreements may contain personal data
- Private storage + SAS meets "appropriate technical measures" requirement
- Access logging provides audit trail for data subject requests

### ISO 27001
- Principle of least privilege: no unnecessary public access
- Defense in depth: application + storage level security
- Access control: time-limited, revocable SAS tokens

---

**Last Updated:** 2026-02-10
**Status:** Active security control
**Review Schedule:** Quarterly
