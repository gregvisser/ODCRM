generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model contact_list_members {
  id            String        @id
  listId        String
  contactId     String
  createdAt     DateTime      @default(now())
  contacts      contacts      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contact_lists contact_lists @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([listId, contactId])
  @@index([contactId])
  @@index([listId])
}

model contact_lists {
  id                   String                 @id
  customerId           String
  name                 String
  description          String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  contact_list_members contact_list_members[]
  customers            customers              @relation(fields: [customerId], references: [id], onDelete: Cascade)
  email_campaigns      email_campaigns[]

  @@index([customerId])
  @@index([customerId, name])
}

model contacts {
  id                       String                     @id
  customerId               String
  firstName                String
  lastName                 String
  jobTitle                 String?
  companyName              String
  email                    String
  phone                    String?
  source                   String                     @default("cognism")
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  status                   ContactStatus              @default(active)
  contact_list_members     contact_list_members[]
  customers                customers                  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  email_campaign_prospects email_campaign_prospects[]

  // New email outreach relationships
  sequenceEnrollments sequence_enrollments[]
  activities contact_activities[]

  @@index([customerId, email])
  @@index([customerId])
  @@index([email])
  @@index([status])
}

model customer_contacts {
  id         String    @id
  customerId String
  name       String
  email      String?
  phone      String?
  title      String?
  isPrimary  Boolean   @default(false)
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  customers  customers @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([email])
}

model customers {
  id                  String              @id
  name                String
  domain              String?
  website             String?
  whatTheyDo          String?
  accreditations      String?
  keyLeaders          String?
  companyProfile      String?
  recentNews          String?
  companySize         String?
  headquarters        String?
  foundingYear        String?
  socialPresence      Json?
  lastEnrichedAt      DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  leadsReportingUrl   String?
  sector              String?
  clientStatus        ClientStatus        @default(active)
  targetJobTitle      String?
  prospectingLocation String?
  monthlyIntakeGBP    Decimal?            @db.Decimal(10, 2)
  defcon              Int?
  weeklyLeadTarget    Int?
  weeklyLeadActual    Int?
  monthlyLeadTarget   Int?
  monthlyLeadActual   Int?
  contact_lists       contact_lists[]
  contacts            contacts[]
  customer_contacts   customer_contacts[]
  email_campaigns     email_campaigns[]
  email_identities    email_identities[]
  email_sequences     email_sequences[]

  // New email outreach relationships
  workspaces workspaces[]
  sequences sequences[]
  emailAccounts email_accounts[]
  contactActivities contact_activities[]

  @@index([clientStatus])
  @@index([domain])
  @@index([id])
  @@index([name])
}

model email_campaign_prospects {
  id                     String                   @id
  campaignId             String
  contactId              String
  senderIdentityId       String
  step1ScheduledAt       DateTime?
  step1SentAt            DateTime?
  step2ScheduledAt       DateTime?
  step2SentAt            DateTime?
  lastStatus             ProspectStatus           @default(pending)
  openCount              Int                      @default(0)
  lastOpenedAt           DateTime?
  unsubscribedAt         DateTime?
  bouncedAt              DateTime?
  replyDetectedAt        DateTime?
  replyCount             Int                      @default(0)
  lastReplySnippet       String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  email_campaigns        email_campaigns          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contacts               contacts                 @relation(fields: [contactId], references: [id], onDelete: Cascade)
  email_identities       email_identities         @relation(fields: [senderIdentityId], references: [id])
  email_events           email_events[]
  email_message_metadata email_message_metadata[]

  @@index([campaignId])
  @@index([campaignId, lastStatus])
  @@index([contactId])
  @@index([lastStatus])
  @@index([senderIdentityId])
  @@index([step1ScheduledAt])
  @@index([step2ScheduledAt])
}

model email_campaign_templates {
  id               String          @id
  campaignId       String
  stepNumber       Int
  subjectTemplate  String
  bodyTemplateHtml String
  bodyTemplateText String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  email_campaigns  email_campaigns @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, stepNumber])
  @@index([campaignId])
}

model email_campaigns {
  id                       String                     @id
  customerId               String
  name                     String
  description              String?
  status                   CampaignStatus             @default(draft)
  senderIdentityId         String
  sendWindowHoursStart     Int                        @default(9)
  sendWindowHoursEnd       Int                        @default(17)
  randomizeWithinHours     Int                        @default(24)
  followUpDelayDaysMin     Int                        @default(3)
  followUpDelayDaysMax     Int                        @default(5)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  listId                   String?
  sequenceId               String?
  email_campaign_prospects email_campaign_prospects[]
  email_campaign_templates email_campaign_templates[]
  customers                customers                  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact_lists            contact_lists?             @relation(fields: [listId], references: [id])
  email_identities         email_identities           @relation(fields: [senderIdentityId], references: [id])
  email_sequences          email_sequences?           @relation(fields: [sequenceId], references: [id])
  email_events             email_events[]

  @@index([customerId])
  @@index([customerId, status])
  @@index([listId])
  @@index([senderIdentityId])
  @@index([sequenceId])
  @@index([status])
}

model email_events {
  id                       String                   @id
  campaignId               String
  campaignProspectId       String
  type                     EventType
  metadata                 Json?
  occurredAt               DateTime                 @default(now())
  createdAt                DateTime                 @default(now())
  email_campaigns          email_campaigns          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  email_campaign_prospects email_campaign_prospects @relation(fields: [campaignProspectId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([campaignId, type])
  @@index([campaignProspectId])
  @@index([occurredAt])
  @@index([type])
}

model email_identities {
  id                       String                     @id
  customerId               String
  emailAddress             String
  displayName              String?
  provider                 String                     @default("outlook")
  outlookTenantId          String?
  outlookUserId            String?
  accessToken              String?
  refreshToken             String?
  tokenExpiresAt           DateTime?
  dailySendLimit           Int                        @default(150)
  isActive                 Boolean                    @default(true)
  lastCheckedAt            DateTime?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  smtpHost                 String?
  smtpPort                 Int?
  smtpUsername             String?
  smtpPassword             String?
  smtpSecure               Boolean?                   @default(true)
  email_campaign_prospects email_campaign_prospects[]
  email_campaigns          email_campaigns[]
  customers                customers                  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  email_message_metadata   email_message_metadata[]

  @@unique([customerId, emailAddress])
  @@index([customerId])
  @@index([emailAddress])
  @@index([isActive])
  @@index([provider])
}

model email_message_metadata {
  id                       String                    @id
  campaignProspectId       String?
  senderIdentityId         String
  providerMessageId        String                    @unique
  threadId                 String?
  direction                MessageDirection          @default(outbound)
  fromAddress              String
  toAddress                String
  subject                  String
  rawHeaders               Json?
  createdAt                DateTime                  @default(now())
  email_campaign_prospects email_campaign_prospects? @relation(fields: [campaignProspectId], references: [id])
  email_identities         email_identities          @relation(fields: [senderIdentityId], references: [id], onDelete: Cascade)

  @@index([campaignProspectId])
  @@index([providerMessageId, threadId])
  @@index([senderIdentityId])
  @@index([threadId])
  @@index([toAddress])
}

model email_sequence_steps {
  id                    String          @id
  sequenceId            String
  stepOrder             Int
  delayDaysFromPrevious Int             @default(0)
  subjectTemplate       String
  bodyTemplateHtml      String
  bodyTemplateText      String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime
  email_sequences       email_sequences @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
}

model email_sequences {
  id                   String                 @id
  customerId           String
  name                 String
  description          String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  email_campaigns      email_campaigns[]
  email_sequence_steps email_sequence_steps[]
  customers            customers              @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([customerId, name])
}

enum CampaignStatus {
  draft
  running
  paused
  completed
}

enum ClientStatus {
  active
  inactive
  onboarding
  win_back
}

enum ContactStatus {
  active
  inactive
  unsubscribed
  bounced
}

enum EventType {
  sent
  bounced
  delivered
  opened
  unsubscribed
  replied
}

enum MessageDirection {
  outbound
  inbound
}

enum ProspectStatus {
  pending
  step1_sent
  step2_sent
  bounced
  unsubscribed
  replied
  completed
}

// ============================================================================
// OPENDOORS EMAIL OUTREACH SYSTEM - NEW MODELS
// Based on Reply.io architecture exploration
// ============================================================================

model workspaces {
  id         String   @id @default(cuid())
  customerId String
  name       String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  customer customers @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@unique([customerId, name])
}

model sequences {
  id                       String          @id @default(cuid())
  customerId               String
  name                     String
  description              String?
  status                   SequenceStatus  @default(draft)
  ownerId                  String?         // User ID
  folderId                 String?
  goalType                 String?
  goalTarget               Int?
  goalDeadline             DateTime?
  sendingTimezone          String          @default("UTC")
  sendingWindowStart       String?         // HH:MM format
  sendingWindowEnd         String?         // HH:MM format
  sendingDaysJson          Json            @default("[true, true, true, true, true, false, false]")
  maxEmailsPerDay          Int             @default(100)
  throttleDelayMinutes     Int             @default(60)
  stopOnReply              Boolean         @default(true)
  stopOnBounce             Boolean         @default(true)
  stopOnUnsubscribe        Boolean         @default(true)
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  createdBy                String?
  totalEnrolled            Int             @default(0)
  totalSent                Int             @default(0)
  totalDelivered           Int             @default(0)
  totalOpened              Int             @default(0)
  totalClicked             Int             @default(0)
  totalReplied             Int             @default(0)
  totalBounced             Int             @default(0)
  totalUnsubscribed        Int             @default(0)

  // Relationships
  customer                 customers       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  steps                    sequence_steps[]
  enrollments              sequence_enrollments[]

  @@index([customerId])
  @@index([status])
}

model sequence_steps {
  id                    String          @id @default(cuid())
  sequenceId            String
  stepOrder             Int
  stepType              String          // 'email', 'task', 'linkedin', 'call', 'conditional', 'delay'
  delayDays             Int             @default(0)
  delayHours            Int             @default(0)
  delayMinutes          Int             @default(0)
  subjectTemplate       String?
  bodyTemplate          String?
  conditions            Json?
  taskTitle             String?
  taskDescription       String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  timesExecuted         Int             @default(0)
  successRate           Decimal?        @db.Decimal(5,2)

  // Relationships
  sequence              sequences       @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
}

model sequence_enrollments {
  id                     String          @id @default(cuid())
  sequenceId             String
  contactId              String
  enrolledAt             DateTime        @default(now())
  enrolledBy             String?
  status                 String          @default("active") // 'active', 'paused', 'completed', 'stopped', 'bounced', 'unsubscribed'
  lastStepCompletedAt    DateTime?
  nextStepScheduledAt    DateTime?
  completedAt            DateTime?
  totalEmailsSent        Int             @default(0)
  totalOpens             Int             @default(0)
  totalClicks            Int             @default(0)
  totalReplies           Int             @default(0)

  // Relationships
  sequence               sequences       @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  contact                contacts        @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, contactId])
  @@index([sequenceId])
  @@index([contactId])
  @@index([nextStepScheduledAt])
}

model email_accounts {
  id                       String          @id @default(cuid())
  customerId               String
  workspaceId              String          // Using customerId for now
  emailAddress             String
  displayName              String?
  provider                 String          @default("outlook") // 'outlook', 'gmail', 'custom_smtp'
  accessToken              String?
  refreshToken             String?
  smtpHost                 String?
  smtpPort                 Int?
  smtpUsername             String?
  smtpPassword             String?
  dailySendLimit           Int             @default(150)
  isActive                 Boolean         @default(true)
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  // Relationships
  customer                 customers       @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, emailAddress])
  @@index([customerId])
  @@index([emailAddress])
  @@index([isActive])
}

model contact_activities {
  id          String    @id @default(cuid())
  contactId   String
  customerId  String
  activityType String   // 'email_sent', 'email_opened', 'email_clicked', 'email_replied', etc.
  occurredAt  DateTime  @default(now())
  metadata    Json      @default("{}")
  processed   Boolean   @default(false)

  // Relationships
  contact     contacts  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  customer    customers @relation(fields: [customerId], references: [id])

  @@index([contactId])
  @@index([customerId])
  @@index([activityType])
  @@index([occurredAt])
}

// Note: Existing customers and contacts models are extended via relationships in the new models above

// ============================================================================
// ENUMS FOR NEW MODELS
// ============================================================================

enum SequenceStatus {
  draft
  active
  paused
  stopped
  archived
}
